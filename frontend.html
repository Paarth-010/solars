<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Optimal Solar Panel Placement</title>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <style>
    /* Root variables */
    :root {
      --bg: #0b1020;
      --bg2: #11162a;
      --card: #0f1528cc;
      --card-border: #1f2a44;
      --text: #e6ecff;
      --muted: #9fb0d3;
      --accent: #6aa3ff;
      --accent-2: #22d3ee;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, var(--bg2) 0%, var(--bg) 60%),
                  linear-gradient(180deg, var(--bg) 0%, #0a0f21 100%);
    }

    #app {
      height: 100vh;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 420px;
      gap: 18px;
      padding: 18px;
      box-sizing: border-box;
    }

    @media (max-width: 1000px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 58vh 1fr;
      }
    }

    #map-wrap {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
      outline: 1px solid rgba(255,255,255,.06);
    }

    #map {
      height: 100%;
      background: #10172a;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .title { margin: 0 0 8px; font-size: 20px; }
    .hint { margin: 4px 0 14px; color: var(--muted); font-size: 13px; }
    label { display: block; font-weight: 600; margin: 14px 0 6px; color: var(--muted); }
    input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color: var(--text);
    }

    .row { margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.22);
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow);
    }
    .btn:disabled { opacity: .55; cursor: not-allowed; }

    .result {
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
      border: 1px dashed var(--card-border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
    }

    .kpi { display: flex; gap: 14px; margin-top: 6px; flex-wrap: wrap; }
    .chip {
      padding: 8px 10px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid var(--card-border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }

    th, td { border: 1px solid var(--card-border); padding: 6px 8px; text-align: right; }
    th:first-child, td:first-child { text-align: left; }

    .compass {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      border: 1px solid var(--card-border);
      display: grid;
      place-items: center;
      position: relative;
      margin-top: 10px;
      background: radial-gradient(120px 120px at 50% 30%, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }

    .compass::before {
      content: "N";
      position: absolute;
      top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .arrow {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 34px solid var(--accent);
      transform-origin: 50% 100%;
    }

    .subtle { color: var(--muted); font-size: 12px; margin-top: 8px; }

    .summary {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }

    /* Simple summary styling */
    .simple-summary {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--card-border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      font-style: italic;
      font-size: 14px;
      border-left: 3px solid var(--accent);
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Map Section -->
    <div id="map-wrap">
      <div id="map"></div>
    </div>

    <!-- Control Panel -->
    <aside class="card" aria-live="polite">
      <h2 class="title">Solar Placement</h2>
      <p class="hint">Draw the roof/ground polygon, or click a single point. Then compute detailed guidance.</p>

      <label for="lat">Latitude</label>
      <input id="lat" type="number" step="0.000001" placeholder="Click map to fill" inputmode="decimal" />

      <label for="lon">Longitude</label>
      <input id="lon" type="number" step="0.000001" placeholder="Click map to fill" inputmode="decimal" />

      <div class="row">
        <button id="optimizeBtn" class="btn" disabled>Get detailed placement</button>
        <button id="fetchLocBtn" class="btn" type="button">Fetch my location</button>
      </div>

      <div class="result">
        <div class="kpi">
          <div class="chip">Tilt: <strong><span id="tilt">—</span>°</strong></div>
          <div class="chip">Azimuth: <strong><span id="az">—</span>°</strong></div>
          <div class="chip">Annual POA: <strong><span id="annual">—</span> kWh/m²</strong></div>
        </div>

        <!-- Simple Concise Summary (like your reference image) -->
        <div id="simpleSummary" class="simple-summary" style="display: none;"></div>
        
        <!-- Detailed Technical Summary -->
        <div id="summary" class="summary" style="display: none;"></div>

        <p id="orientationText" class="hint"></p>

        <div class="compass">
          <div id="arrow" class="arrow" style="transform: rotate(0deg);"></div>
        </div>

        <table id="monthly">
          <thead>
            <tr>
              <th>Month</th>
              <th>POA kWh/m²</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <p id="surfaceNote" class="subtle"></p>
        <p id="note" class="hint"></p>
      </div>
    </aside>
  </div>

  <!-- Scripts -->
  <script src="leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    const API_BASE = "http://localhost:8000";

    // Initialize Map
    const WORLD_BOUNDS = [[-85.05112878, -180], [85.05112878, 180]];
    const map = L.map("map", { maxBounds: WORLD_BOUNDS, maxBoundsViscosity: 1.0 }).setView([20, 78], 3);

    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
      { attribution: "© OpenStreetMap contributors, © CARTO", subdomains: ["a","b","c","d"], maxZoom: 19, noWrap: true }
    ).addTo(map);

    L.control.scale().addTo(map);

    // Draw controls
    const drawn = new L.FeatureGroup().addTo(map);
    const drawControl = new L.Control.Draw({
      draw: { polygon: { showArea: true }, rectangle: false, circle: false, marker: false, polyline: false, circlemarker: false },
      edit: { featureGroup: drawn }
    });
    map.addControl(drawControl);

    let sitePolygon = null;
    let pickMarker = null;
    let installMarker = null;

    map.on(L.Draw.Event.CREATED, e => {
      if (sitePolygon) drawn.removeLayer(sitePolygon);
      sitePolygon = e.layer;
      drawn.addLayer(sitePolygon);
    });

    map.on("draw:deleted", () => { sitePolygon = null; });

    // Click to set point
    map.on("click", e => {
      const { lat, lng } = e.latlng;
      document.getElementById("lat").value = lat.toFixed(6);
      document.getElementById("lon").value = lng.toFixed(6);
      document.getElementById("optimizeBtn").disabled = false;

      if (pickMarker) pickMarker.remove();
      pickMarker = L.marker([lat, lng])
        .addTo(map)
        .bindPopup(`Lat ${lat.toFixed(4)}, Lon ${lng.toFixed(4)}`)
        .openPopup();
    });

    // Update marker when lat/lon inputs change
    function updateMarkerPosition() {
      var lat = parseFloat(document.getElementById('lat').value);
      var lng = parseFloat(document.getElementById('lon').value);
      if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
        if (pickMarker) {
          pickMarker.setLatLng([lat, lng]);
        } else {
          pickMarker = L.marker([lat, lng])
            .addTo(map)
            .bindPopup(`Lat ${lat.toFixed(4)}, Lon ${lng.toFixed(4)}`);
        }
        map.panTo([lat, lng]);
        document.getElementById('optimizeBtn').disabled = false;
      } else {
        if (pickMarker) { 
          pickMarker.remove(); 
          pickMarker = null; 
        }
        if (!isNaN(lat) && !isNaN(lng)) {
          document.getElementById('optimizeBtn').disabled = true;
        }
      }
    }

    document.getElementById('lat').addEventListener('input', updateMarkerPosition);
    document.getElementById('lon').addEventListener('input', updateMarkerPosition);

    // Geolocation
    async function fetchLoc() {
      const btn = document.getElementById("fetchLocBtn");
      const old = btn.innerText;
      btn.disabled = true;
      btn.innerText = "Locating…";

      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          document.getElementById("lat").value = latitude.toFixed(6);
          document.getElementById("lon").value = longitude.toFixed(6);
          updateMarkerPosition(); // Trigger marker update
          map.setView([latitude, longitude], 16);
          btn.disabled = false;
          btn.innerText = old;
        },
        err => {
          alert(err?.message || "Failed to fetch location.");
          btn.disabled = false;
          btn.innerText = old;
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    document.getElementById("fetchLocBtn").addEventListener("click", fetchLoc);

    // Helper functions
    function summarizeSurface(heat, bestKwh, secondBest) {
      const delta = bestKwh - (secondBest || 0);
      const strength = delta >= 150 ? 'strong' : delta >= 60 ? 'moderate' : 'flat';
      return `Orientation surface is ${strength} (best minus next: ${delta.toFixed(0)} kWh/m²). Small mounting errors will${strength==='flat'?' not':''} reduce yield significantly.`;
    }

    // Optimize Handler
    async function optimize() {
      const lat = parseFloat(document.getElementById("lat").value);
      const lon = parseFloat(document.getElementById("lon").value);
      const note = document.getElementById("note");

      if (Number.isNaN(lat) || Number.isNaN(lon)) {
        alert("Select a point or draw a polygon first.");
        return;
      }

      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const geo = sitePolygon ? sitePolygon.toGeoJSON() : null;
      const btn = document.getElementById("optimizeBtn");
      const old = btn.innerText;

      btn.disabled = true;
      btn.innerText = "Computing…";
      note.textContent = "Evaluating full orientation surface and monthly yield…";

      try {
        const res = await fetch(`${API_BASE}/optimize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ lat, lon, tz, polygon: geo })
        });

        if (!res.ok) throw new Error(`API error: ${res.status}`);
        const data = await res.json();
        
        console.log("Full API Response:", data);

        // Update KPIs
        document.getElementById("tilt").textContent = (data.tilt_deg || 0).toFixed(1);
        document.getElementById("az").textContent = (data.azimuth_deg || 0).toFixed(0);
        document.getElementById("annual").textContent = (data.annual_poa_kwh_m2 || 0).toFixed(0);
        document.getElementById("orientationText").textContent = data.orientation_text || "";
        document.getElementById("arrow").style.transform = `rotate(${data.azimuth_deg || 0}deg)`;

        // Simple summary - FORCE DISPLAY
        const simpleEl = document.getElementById("simpleSummary");
        simpleEl.textContent = data.simple_summary || "Summary not available";
        simpleEl.style.display = "block";

        // Detailed summary - FORCE DISPLAY  
        const sumEl = document.getElementById("summary");
        sumEl.textContent = data.summary_text || "Detailed summary not available";
        sumEl.style.display = "block";

        // Monthly table - FORCE DISPLAY
        const tbody = document.querySelector("#monthly tbody");
        tbody.innerHTML = "";
        const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        
        if (data.monthly_poa_kwh && data.monthly_poa_kwh.length >= 12) {
          for (let i = 0; i < 12; i++) {
            const value = Number(data.monthly_poa_kwh[i]) || 0;
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${months[i]}</td><td>${value.toFixed(1)}</td>`;
            tbody.appendChild(tr);
          }
        } else {
          tbody.innerHTML = "<tr><td colspan='2'>Monthly data error</td></tr>";
        }

        // Surface analysis
        const delta = (data.annual_poa_kwh_m2 || 0) - (data.second_best_kwh || 0);
        const strength = delta >= 150 ? 'strong' : delta >= 60 ? 'moderate' : 'flat';
        document.getElementById("surfaceNote").textContent = 
          `Orientation surface is ${strength} (best minus next: ${delta.toFixed(0)} kWh/m²). Small mounting errors will${strength==='flat'?' not':''} reduce yield significantly.`;

        // Best point marker
        if (data.best_point && Array.isArray(data.best_point) && data.best_point.length === 2) {
          const [lng, lat] = data.best_point;
          if (installMarker) installMarker.remove();
          installMarker = L.marker([lat, lng], { title: "Install here" })
            .addTo(map)
            .bindPopup(`${data.orientation_text}<br/>Annual POA: ${(data.annual_poa_kwh_m2 || 0).toFixed(0)} kWh/m²`)
            .openPopup();
          map.setView([lat, lng], Math.max(17, map.getZoom()));
        }

        note.textContent = "Tip: keep the panel row edges clear of 9–11 AM and 2–4 PM shadows to protect most energy hours.";

      } catch (e) {
        console.error("Error:", e);
        note.textContent = `Failed: ${e.message}`;
      } finally {
        btn.disabled = false;
        btn.innerText = old;
      }
    }

    document.getElementById("optimizeBtn").addEventListener("click", optimize);
  </script>
</body>
</html>
